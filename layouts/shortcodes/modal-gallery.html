{{/*
  Paige Modal Gallery Shortcode
  Prevents image filenames from being displayed as captions.
*/}}
{{ $images_param := .Get 0 | default (.Get "images") }}
{{ $width := .Get "width" | default "20rem" }}
{{ $class := .Get "class" | default "rounded-3" }}
{{ $loading := .Get "loading" | default "lazy" }}
{{ $align := .Get "align" | default "center" }}
{{ $justify := .Get "justify" | default "center" }}
{{ $breakpoints := .Get "breakpoints" }}
{{ $densities := .Get "densities" }}
{{ $fetchpriority := .Get "fetchpriority" }}
{{ $page := .Page }}
{{ $process := .Get "process" }}

{{ $resources := slice }}

{{/* Find the image resources based on the provided pattern */}}
{{ if not $images_param }}
    {{ with .Page.Resources.ByType "image" }}
        {{ $resources = . }}
    {{ end }}
{{ else }}
    {{ with $.Page.Resources.Match $images_param }}
        {{ $resources = . }}
    {{ else }}
        {{ $resources = resources.Match $images_param }}
    {{ end }}
{{ end }}

{{ if not $resources }}
    {{ errorf "layouts/shortcodes/modal-gallery.html: No images found with pattern %q in %s" $images_param $.Page.RelPermalink }}
{{ end }}

{{ $gallery_id := printf "modalGallery-%s" (md5 $.Page.RelPermalink) }}

<div class="align-items-{{ $align }} column-gap-3 d-flex flex-wrap justify-content-{{ $justify }} row-gap-3 paige-modal-gallery">

    {{ range $index, $resource := $resources }}
        {{/*
          Generate a safe, generic alt text for the thumbnail.
        */}}
        {{ $alt_text := $resource.Title | default (printf "Gallery Image %d" (add $index 1)) }}

        <a href="#" data-bs-toggle="modal" data-bs-target="#{{ $gallery_id }}" data-bs-slide-to="{{ $index }}" aria-label="Slide {{ add $index 1 }}">
            {{ partial "paige/image.html" (dict
                "Page" $.Page
                "resource" $resource
                "alt" $alt_text
                "width" $width
                "class" $class
                "loading" $loading
                "breakpoints" $breakpoints
                "densities" $densities
                "fetchpriority" $fetchpriority
                "process" $process
            ) }}
        </a>
    {{ end }}
</div>

{{/* FIX: Added data-bs-backdrop="static" to prevent closing the modal when clicking the arrows outside the image content */}}
<div class="modal fade" id="{{ $gallery_id }}" tabindex="-1" aria-labelledby="{{ $gallery_id }}Label" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-md-down" style="max-width: 35vw;">
        <div class="modal-content bg-transparent border-0">
            {{/* MODAL HEADER: pb-4 adds the vertical gap below the close button */}}
            <div class="modal-header border-0 pb-4 justify-content-end">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0 px-2 text-center">

                <div id="carousel-{{ $gallery_id }}" class="carousel slide" data-bs-interval="false">
                    <div class="carousel-inner">
                        {{ range $index, $resource := $resources }}
                            <div class="carousel-item {{ if eq $index 0 }}active{{ end }}">
                                {{ $alt_text := $resource.Title | default (printf "Gallery Image %d" (add $index 1)) }}

                                <img src="{{ $resource.RelPermalink }}" class="d-block img-fluid rounded-3 img-fixed-fit" alt="{{ $alt_text }}">

                                {{ with $resource.Params.caption }}
                                    <div class="carousel-caption d-none d-md-block">
                                        <p class="text-white">{{ . }}</p>
                                    </div>
                                {{ end }}
                            </div>
                        {{ end }}
                    </div>

                    {{/* ARROWS MOVED BACK INSIDE the carousel div for functionality */}}
                    {{ if gt (len $resources) 1 }}
                    <button class="carousel-control-prev custom-arrow" type="button" data-bs-target="#carousel-{{ $gallery_id }}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next custom-arrow" type="button" data-bs-target="#carousel-{{ $gallery_id }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {{ end }}

                </div>

            </div>
        </div>
    </div>
</div>

<style>
/* 1. STABILITY FIX: LOCK DOWN the height of the main carousel containers to prevent shifting */
.modal-body {
    /* The modal-body height must be fixed to prevent vertical jumps */
    height: 85vh; /* Adjust this value to set the fixed height of the display area */
    display: flex; /* Use flex to ensure the carousel inside fills the height */
    flex-direction: column;
    padding-bottom: 0 !important; /* Remove bottom padding to maximize vertical space */
}

.carousel {
    /* Ensure the carousel takes up all available height in the modal-body */
    height: 100%;
    /* FIX: Make the carousel the positioning context for the arrows inside it */
    position: relative; 
}

.carousel-inner {
    /* Ensure the inner container fills the space */
    height: 100%;
}

/* 2. CENTERING FIX */
.paige-modal-gallery .carousel-item {
    /* The item must fill the carousel-inner's 100% height */
    height: 100%; 
    
    /* Use flexbox to center content vertically and horizontally */
    display: flex;
    justify-content: center;
    align-items: center;
}

/* 3. IMAGE SCALING */
.paige-modal-gallery .carousel-item img {
    /* Ensure the image fits within the fixed-height item */
    max-width: 100%;
    max-height: 100%;
    /* Maintain aspect ratio and fit fully without cropping */
    object-fit: contain; 
    width: auto;
    height: auto;
}

/* 4. ARROW FIX: Position controls correctly centered and outside the image area */

/* Re-apply absolute positioning and centering for the full-screen effect. 
   We will target the .modal-dialog for horizontal placement, but the vertical
   center relative to the carousel itself should be enough, given the carousel 
   is set to 100% height of the body.
*/
.custom-arrow {
    /* FIX: Reset these to be absolutely positioned relative to the .carousel */
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    
    /* Ensure they are on top of the modal backdrop if applicable */
    z-index: 1060;
}

/* Horizontal positioning */
.carousel-control-prev.custom-arrow {
    /* Push the button to the left edge of the carousel, then outside */
    left: 0;
    margin-left: -5rem; /* Adjust this value to control distance from the left edge */
}

.carousel-control-next.custom-arrow {
    /* Push the button to the right edge of the carousel, then outside */
    right: 0;
    margin-right: -5rem; /* Adjust this value to control distance from the right edge */
}
</style>